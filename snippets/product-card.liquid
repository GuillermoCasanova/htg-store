{% comment %}
    Renders a product card

    Accepts:
    - heading_level: {String} The heading level for this product card, depends if nested. 
    - card_product: {Object} Product Liquid object (optional)
    - show_quick_add: {Boolean} Show the quick add button.
    - section_id: {String} The ID of the section that contains this card.

    Usage:
    {% render 'product-card', show_quick_add: section.settings.enable_quick_add %}
{% endcomment %}


<div class="product-card-wrapper underline-links-hover">
    <div class="product-card  {% if card_product.available == false %} product-card--sold-out {% endif %}">
      <div class="product-card__inner">
          <div class="product-card__media">

            <div class="product-card__badge">
              {%- if card_product.available == false -%}
                <span class="product-card__badge__text--sold-out">{{ 'products.product.sold_out' | t }}</span>
              {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
                <span class="product-card__badge__text--on-sale">{{ 'products.product.on_sale' | t }}</span>
              {%- endif -%}
            </div>

            {%- if show_quick_add and card_product.available == true -%}
              <div class="quick-add-button-container">
                <button type="submit" class="button  quick-add-button">
                  Quick Add +
                </button>
              </div>
            {%- endif -%}

            <a title="Shop {{ card_product.title | escape }}" rel="internal" href="{{ card_product.url }}" class="media media--square">
              {% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
              <img
                srcset="{%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 720 -%}{{ card_product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 940 -%}{{ card_product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
                  {%- if card_product.featured_media.width >= 1066 -%}{{ card_product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}
                  {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w"
                src="{{ card_product.featured_media | image_url: width: 533 }}"
                sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                alt="{{ card_product.featured_media.alt | escape }}"
                class="motion-reduce"
                aria-hidden="true"
                loading="lazy"
                width="{{ card_product.featured_media.width }}"
                height="{{ card_product.featured_media.height }}"
              >
              {% comment %}theme-check-enable ImgLazyLoading{% endcomment %}
  
              {%- if card_product.media[1] != nil -%}
                <img
                  srcset="{%- if card_product.media[1].width >= 165 -%}{{ card_product.media[1] | image_url: width: 165 }} 165w,{%- endif -%}
                    {%- if card_product.media[1].width >= 360 -%}{{ card_product.media[1] | image_url: width: 360 }} 360w,{%- endif -%}
                    {%- if card_product.media[1].width >= 533 -%}{{ card_product.media[1] | image_url: width: 533 }} 533w,{%- endif -%}
                    {%- if card_product.media[1].width >= 720 -%}{{ card_product.media[1] | image_url: width: 720 }} 720w,{%- endif -%}
                    {%- if card_product.media[1].width >= 940 -%}{{ card_product.media[1] | image_url: width: 940 }} 940w,{%- endif -%}
                    {%- if card_product.media[1].width >= 1066 -%}{{ card_product.media[1] | image_url: width: 1066 }} 1066w,{%- endif -%}
                    {{ card_product.media[1] | image_url }} {{ card_product.media[1].width }}w"
                  src="{{ card_product.media[1] | image_url: width: 533 }}"
                  sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                  alt="{{ card_product.media[1].alt | escape }}"
                  aria-hidden="true"
                  class="motion-reduce"
                  loading="lazy"
                  width="{{ card_product.media[1].width }}"
                  height="{{ card_product.media[1].height }}"
                >
              {%- endif -%}
            </a>
          </div>
      </div>
  
      <div class="product-card__content">
        <a title="Shop {{ card_product.title | escape }}" rel="internal" href="{{ card_product.url }}" tabindex="-1" class="product-card__information">
            {% if heading_level == 'h2' %}
          <h2 class="product-card__heading" id="title-{{ section_id }}-{{ card_product.id }}">
              {{ card_product.title | escape }}
          </h2>
          {% endif %}
          
          {% if heading_level == 'h3' %}
          <h3 class="product-card__heading" id="title-{{ section_id }}-{{ card_product.id }}">
              {{ card_product.title | escape }}
          </h3>
          {% endif %}

          <div class="product-card__price-info">
            {% render 'price', product: card_product, price_class: 'product-card__price' %}
          </div>
        </a>
      </div>
    </div>
  
    {%- if show_quick_add and card_product.available == true -%}
     <div class="quick-add no-js-hidden">
      {%- assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id -%}
      <div class="quick-add__button-container">
        {%- if card_product.has_only_default_variant -%}
          <form>
              <button type="submit" class="visually-hidden" tabindex="-1">
                Submit
              </button>
          </form>
        {%else%}
          <form>
            <div>
              {% for collection in card_product.collections %}

                {%assign collectionName = collection.title | downcase | handleize -%}
                {%assign productName = card_product.title | downcase | split: "-" -%}
                {%assign productNameHandle = productName[0] | handleize%}

                {% if productNameHandle == collectionName and card_product.metafields.color_swatch.name %}
                {%assign activeCollection = collection %}
                <div class="custom-color-picker  x-product-form__input">
                  <fieldset>
                  <legend  class="custom-color-picker__current-color visually-hidden" >
                    <span class="custom-color-picker__current-color__label">Available colors for {{productName[0]}}:</span>
                  </legend>
                  <span class="custom-color-picker__colors">
                    {% for product in activeCollection.products %}
                        <span class="custom-color-picker__color {% if product.handle == activeProduct.handle %}is-selected{% endif %}">
                            
                              <input type="radio" 
                                 id="{{ section.id }}-{{ card_product.id }}-{{ product.metafields.color_swatch.name }}"
                                name="color" 
                                value="{{ value | escape }}"
                                title="Shop {{ product.title }} in {{ product.metafields.color_swatch.name }}" 
                                data-color-option
                                data-product="{{ product | json | escape }}"
                                data-color-name="{{ image.alt | remove: 'swatch_' | replace: '-', ' ' | capitalize }}" 
                                data-product-title="{{ product.title }}" 
                                data-handle="{{ product.handle }}"
                                data-product-description="{{ product.description | escape }}"
                                data-product-url="{{ product.url }}"
                                data-product-id="{{ product.id }}"
                                data-product-first-variant="{{ product.selected_variant.id }}"
                                data-swatch="{{ product.metafields.color_swatch.name }}"
                                class="custom-color-picker__input"
                                >
                                <label class="custom-color-picker__label" for="{{ section.id }}-{{ card_product.id }}-{{ product.metafields.color_swatch.name }}" data-color-label data-color-name="{{ product.metafields.color_swatch.name }}">
                                  <span class="custom-color-picker__label__swatch" style="background-color: {{ product.metafields.color_swatch.hex_color }};">
                                    x
                                  </span>
                                  <span class="custom-color-picker__label__ring">
                                    
                                  </span>
                                </label>
                              </span>
                    {% endfor %}
                    </span>
                </fieldset>
                </div> 
                {%   endif   %}
 
              {% endfor %}
            </div>
            <div>
              <div data-section="{{ section.id }}" data-url="{{ card_product.url }}">
                {%- for option in card_product.options_with_values -%}
                    <fieldset class="js product-form__input">
                      <legend class="form__label visually-hidden">{{ option.name }}</legend>
                      {%- for value in option.values -%}
                        <input type="radio" id="{{ section.id }}-{{ card_product.id }}-{{ option.position }}-{{ forloop.index0 }}"
                              name="{{ option.name }}"
                              value="{{ value | escape }}"
                              form="{{ product_form_id }}"
                              {% if option.selected_value == value %}checked{% endif %}
                        >
                        <label for="{{ section.id }}-{{ card_product.id }}-{{ option.position }}-{{ forloop.index0 }}">
                          {{ value }}
                        </label>
                      {%- endfor -%}
                    </fieldset>
                {%- endfor -%}
                <script type="application/json">
                  {{ card_product.variants | json }}
                </script>
              </div>
            </div>
            
            <button type="submit" class="visually-hidden" tabindex="-1">
              Submit
            </button>
          </form>
         
        {%- endif -%}
      </div>
    </div>
    {%- endif -%}

  </div>
  